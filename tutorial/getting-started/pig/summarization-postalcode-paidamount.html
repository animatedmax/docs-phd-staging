<!doctype html>
<html>
<head>
  <meta charset="utf-8">

  <!-- Always force latest IE rendering engine or request Chrome Frame -->
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">

  <!-- Use title if it's in the page YAML frontmatter -->
  <title>
      Pig - Top Ten Postal Codes by Revenue |
    Pivotal Docs
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link href="/stylesheets/master.css" rel="stylesheet" type="text/css" media="screen,print" />
  <link href="/stylesheets/print.css" rel="stylesheet" type="text/css" media="print" />
  <link href='http://www.gopivotal.com/misc/favicon.ico' rel='shortcut icon'>

  <script src="/javascripts/all.js" type="text/javascript"></script>



  <script type="text/javascript">
    if (window.location.host === 'pivotalhd.docs.pivotal.io') {
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-39702075-1']);
      _gaq.push(['_setDomainName', 'gopivotal.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    }
  </script>
</head>

<body class="tutorial tutorial_getting-started tutorial_getting-started_pig tutorial_getting-started_pig_summarization-postalcode-paidamount has-subnav">

<div class="viewport">
<div class='wrap'>
  <script src="//use.typekit.net/clb0qji.js" type="text/javascript"></script>
  <script type="text/javascript">
      try {
          Typekit.load();
      } catch (e) {
      }
  </script>
  <script type="text/javascript">
      document.domain = "gopivotal.com";
  </script>

  <script type="text/javascript">
    WebFontConfig = {
      google: { families: [ 'Source+Sans+Pro:300italic,400italic,300,400,600:latin' ] }
    };
    (function() {
      var wf = document.createElement('script');
      wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
        '://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js';
      wf.type = 'text/javascript';
      wf.async = 'true';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(wf, s);
    })();
  </script>

    <header class="header header-layout">
      <h1 class="logo">
        <!-- <a href="/"> -->
            <ul class="breadcrumbs"><li><a href="/tutorial/getting-started/pig.html">Pig Getting Started</a></li> <li class="active"><span>Pig - Top Ten Postal Codes by Revenue</span></li></ul>
        <!-- </a> -->
      <a href="/index.html">Pivotal HD Documentation</a></h1>
      <div class="header-links js-bar-links">
        <div class="btn-menu" data-behavior="MenuMobile"></div>
        <div class="header-item">
          <a href="http://docs.pivotal.io/index.html">Docs Home</a>
        </div>
        <!--
        <div class="header-item">
          <a href="http://support.gopivotal.com" target="_blank">Support</a>
        </div>
        -->
         <div class="header-item">
          <a href="http://ask.gopivotal.com/hc/en-us/categories/200072578-Pivotal-HD-Knowledge-Base" target="_blank">Knowledge Base</a>
        </div>
        <div class="header-item">
          <a href="http://ask.gopivotal.com/hc/communities/public/topics/200053048-Pivotal-HD-General" target="_blank">Forum</a>
        
        
        
        <div class="header-item searchbar js-searchbar">
          <a class="search-icon" data-behavior="Search"></a>
          <div class="search-input">
            <!-- Google CSE Search Box -->
            <div class="search-input-inner" id="docs-search">
                <gcse:search></gcse:search>
            </div>
          </div>
        </div>
      </div>
    </header>

  <div class="container">

      <div id="sub-nav" class="js-sidenav nav-container" role="navigation">
 <a class="sidenav-title" data-behavior="SubMenuMobile">
    Doc Index
  </a>
 <div class="nav-content">
  <ul class="menu">
              <!-- REPLACE <li/> NODES-->
              

        <li class="menu-item js-menu-item">            
      <div class="menu-title js-menu-title">
          	    <a id='home-nav-link' href="/tutorial/index.html">Getting Started with the Pivotal HD Tutorial </a>
      </div> 
         </li>
              
             <div class="menu-title js-menu-title">
                <li class="menu-link">
                  <a  href="/tutorial/getting-started-overview.html">Setting Up the Pivotal HD Tutorial</a>
             </div>
                  <ul >
                    <li class="menu-link"><a href='/tutorial/getting-started/pivotalhd-vm.html'>Pivotal HD Virtual Machine</a></li>
               
                    <li class="menu-link"><a href='/tutorial/getting-started/dataset.html'>Loading the Retail Demo Dataset</a></li>
					
                  </UL>
			    </li>
			
			  <div class="menu-title js-menu-title">
				<li class="menu-item">
				  <a  href="/tutorial/getting-started/overview.html">Tutorials Overview</a>
				</div>
				<ul >
<div class="menu-title js-menu-title">
                    <li class="menu-link"><a href='/tutorial/getting-started/map-reduce-java.html'>MapReduce Java</a>
                    </div>
                      <ul >
                        <li class="menu-link"><a href='/tutorial/getting-started/map-reduce-java/summarization-postalcode-paidamount.html'>Summarization: PostalCode with Highest Revenue</a></li>
                        <li class="menu-link"><a href='/tutorial/getting-started/map-reduce-java/firstandlastorderiddate.html'>Minimum/Maximum: Last and First order date</a></li>
                      </ul>
                    </li> <div class="menu-title">
                    <li class="menu-item" ><a href='/tutorial/getting-started/hawq.html'>HAWQ</a>
						</div>
                      <ul >
                        <li class="menu-link"><a href='/tutorial/getting-started/hawq/internal-tables.html'>HAWQ Internal Tables</a></li>
                        <li class="menu-link"><a href='/tutorial/getting-started/hawq/pxf-external-tables.html'>PXF External Tables: HDFS</a></li>
                        <li class="menu-link"><a href='/tutorial/getting-started/hawq/pxf-hbase-external-tables.html'>PXF External Tables: HBase</a></li>
                        <li class="menu-link"><a href='/tutorial/getting-started/hawq/pxf-hbase-external-enable-filter-pushdown.html'>PXF External Tables Predicate Push-down: HBase</a></li>
                        <li class="menu-link"><a href='/tutorial/getting-started/hawq/pxf-external-tables-statistics.html'>PXF External Tables: Statistics</a></li>
                      </ul>
                    </li><div class="menu-title">
                    <li class="menu-item"><a href='/tutorial/getting-started/hive/hive-tables.html'>Hive</a></div>
                     <ul >
                        <li class="menu-item"><a href='/tutorial/getting-started/hive/hive-tables.html'>Hive Tables</a></li>
                      </ul> 
					
                    </li>
                     <div class="menu-title">
                    <li class="menu-item"><a href='/tutorial/getting-started/pig.html'>Pig</a>
                    </div>
                      <ul >
                        <li class="menu-link"><a href='/tutorial/getting-started/pig/summarization-postalcode-paidamount.html'>Top ten postal codes</a></li>
                        <li class="menu-link"><a href='/tutorial/getting-started/pig/firstandlastorderiddate.html'>Last and First order date of all the customers</a></li>
                      </ul>
                    </li>
				
                   <!-- <li class="menu-link"><a href='/tutorial/getting-started/spring-data-hadoop.html'>Spring Data Hadoop</a>
                      <ul >
                        <li class="menu-link"><a href='/tutorial/getting-started/spring-data-hadoop/wordcount_with_spring_hadoop-gphd.html'>Word Count with Spring Data on Pivotal HD</a></li>
                        <li class="menu-link"><a href='/tutorial/getting-started/spring-data-hadoop/wordcount_with_spring_hadoop.html'>Word Count with Spring Data on Hadoop 2.2.0</a></li>
                      </ul>
                    </li>-->
                  </ul>
                </li>
			  <div class="menu-title js-menu-title">
				 <li><a href="http://gemfirexd.docs.gopivotal.com/latest/userguide/index.html#getting_started/tutorial_chapter_intro.html" target="_blank">GemFire XD Quickstart</a></li>
				 </div>
			 </ul>
                	</li>
              </ul>
           </div>   
        </div><!--end of sub-nav-->

      <main class="content content-layout" id="js-content" role="main">
        <a id="top"></a>
          <h1 class="title-container">
            Pig - Top Ten Postal Codes by Revenue
          </h1>
            <div id="js-quick-links">
              
            </div>
        <div class="to-top" id="js-to-top">
          <a href="#top" title="back to top"></a>
        </div>
        <h1>Overview</h1>

<p>The retail demo dataset has information about customer orders. The data for each order contains the postal code of the customer. In this example you run Pig Latin statements to return the top ten postal codes by revenue.</p>

<h1>Prerequisites</h1>

<ol>
<li><p>Install the Pivotal HD Single-Node Virtual Machine and start the Pivotal HD services. See <a href="/tutorial/getting-started/pivotalhd-vm.html">Pivotal HD Single-Node VM</a>.</p></li>
<li><p>Load the Retail Demo Dataset before following the steps in this section. See <a href="/tutorial/getting-started/dataset.html">Retail Demo Dataset</a>.</p></li>
</ol>

<h1>Installation</h1>

<p>Pig is included with the Pivotal HD distribution. You use the Pig service to upload and query the data.</p>

<h1>Using Pig to Return the Top ten Postal Codes</h1>

<p>You create Pig Latin statements to process data using Pig. You use these statements to create an object called a relation.  A relation is a collection of tuples. You can use a relation to define another relation. </p>

<ol>
<li><p>Start the Pig interactive <code>grunt</code> shell by issuing the <code>pig</code> command: </p>

<pre class="terminal">$ pig
grunt> 
</pre></li>
<li><p>Verify that <code>orders.tsv.gz</code> is available in HDFS:</p>

<pre class="terminal">
grunt> fs -ls /retail_demo/orders;
Found 1 items
-rw-r--r--   3 gpadmin hadoop   72797064 2013-06-25 10:13 /retail_demo/orders/orders.tsv.gz
</pre></li>
<li><p>Create a Pig <em>relation</em> named <code>orders</code> from <code>orders.tsv</code>:</p>

<pre class="terminal">
grunt> orders = LOAD '/retail_demo/orders/orders.tsv.gz'
USING PigStorage('\t') AS (
order_id : long,
customer_id : int,
store_id : int,
order_datetime : chararray,
ship_completion_datetime : chararray,
return_datetime : chararray,
refund_datetime : chararray,
payment_method_code : chararray,
total_tax_amount :double,
total_paid_amount : double,
total_item_quantity : int,
total_discount_amount : int,
coupon_code : chararray,
coupon_amount : int,
order_canceled_flag : chararray,
has_returned_items_flag : chararray,
has_refunded_items_flag : chararray,
fraud_code : chararray,
fraud_resolution_code : chararray, 
billing_address_line1 : chararray,
billing_address_line2 : chararray,
billing_address_line3 : chararray,
billing_address_city : chararray,
billing_address_state : chararray,
billing_address_postal_code : int,
billing_address_country : chararray,
billing_phone_number : chararray,
customer_name : chararray,
customer_email_address :chararray,
ordering_session_id : int,
website_url : chararray
);
</pre></li>
<li><p>Use the group operator to create a relation that groups the records by the <code>billing_address_postal_code</code> column:</p>

<pre class="terminal">
grunt> pcode = GROUP orders BY billing_address_postal_code;
</pre>

<p>The <code>group</code> operator collects records with <code>billing_address_postal_code</code> as a key.</p></li>
<li><p>Create a relation that calculates the sum of the <code>total_paid_amount</code> and <code>total_tax_amount</code> columns for  each <code>pcode</code> record: </p>

<pre class="terminal">
grunt> revenue_counts = FOREACH pcode GENERATE group as zip,
 SUM(orders.total_paid_amount) as total,SUM(orders.total_tax_amount); 
</pre>

<p>The <code>foreach</code> statement applies the <code>sum</code> method to every record collected in the <code>pcode</code> relation.</p></li>
<li><p>Order the <code>revenue_counts</code> records in descending order:</p>

<pre class="terminal">
grunt>order_revenue = order revenue_counts by total DESC;
</pre>

<p>The <code>order</code> statement sorts <code>revenue_counts</code> data in descending order using <code>DESC</code> </p></li>
<li><p>Get the top ten records:  </p>

<pre class="terminal">
grunt> firstten = limit order_revenue 10;
</pre>

<p>The <code>limit</code> will return at most 10 records of <code>order_revenue</code></p></li>
<li><p>Use the <code>dump</code> operator to display the output of the <code>firstten</code> relation:  </p>

<pre class="terminal">
grunt> dump firstten;
...
(48001,111868.31999999999,6712.0992)
(15329,107958.24,6477.4944)
(42714,103244.58,6194.6748)
(41030,101365.50000000001,6081.930000000001)
(50223,100511.64,6030.698400000001)
(3106,83566.41000000002,0.0)
(57104,77383.62999999999,3095.3452)
(23002,73673.66000000002,3683.6829999999995)
(25703,68282.12,4096.9272)
(26178,66836.4,4010.1839999999997)
</pre></li>
<li><p>Save the output to a file using <code>store</code>:</p>

<pre class="terminal">
grunt> store firstten into '/user/gpadmin/output/' ;
grunt> fs -cat /user/gpadmin/output/part*
48001    111868.31999999999    6712.0992
15329    107958.24    6477.4944
42714    103244.58    6194.6748
41030    101365.50000000001    6081.930000000001
50223    100511.64    6030.698400000001
3106    83566.41000000002    0.0
57104    77383.62999999999    3095.3452
23002    73673.66000000002    3683.6829999999995
25703    68282.12    4096.9272
26178    66836.4    4010.1839999999997
</pre></li>
</ol>

<h1>Summary</h1>

<p>In this exercise you used Pig <strong>relational operators</strong> like <code>group</code>, <code>foreach</code>, <code>sum</code>, <code>order</code> and <code>limit</code> to calculate the top ten postal codes by revenue.</p>

      </main><!--end of content-->

  </div><!-- end of container -->

  <script type="text/javascript">
    (function() {
      var didInit = false;
      function initMunchkin() {
        if(didInit === false) {
          didInit = true;
          Munchkin.init('625-IUJ-009');
        }
      }
      var s = document.createElement('script');
      s.type = 'text/javascript';
      s.async = true;
      s.src = document.location.protocol + '//munchkin.marketo.net/munchkin.js';
      s.onreadystatechange = function() {
        if (this.readyState == 'complete' || this.readyState == 'loaded') {
          initMunchkin();
        }
      };
      s.onload = initMunchkin;
      document.getElementsByTagName('head')[0].appendChild(s);
    })();
  </script>
</div><!--end of wrap-->
</div><!--end of viewport-->

<div id="scrim"></div>

<div class="container">
  <footer class="site-footer-links">
    <div class="copyright">
      <a href='/'>Pivotal Documentation</a>
      &copy; 2015 <a href='http://gopivotal.com'>Pivotal Software</a>, Inc. All Rights Reserved.
  </div>
  <div class="support">
    Need help? <a href="http://support.gopivotal.com" target="_blank">Visit Support</a>
  </footer>
</div><!--end of container-->

</body>
</html>
